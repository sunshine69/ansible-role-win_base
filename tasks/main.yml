- name: Make sure ansible-install dir exist
  win_file:
    path: '{{ ansible_install_dir }}'
    state: directory

- set_fact:
    machine_arch: "{{ 'x86' if ansible_env.PROCESSOR_ARCHITECTURE == 'x86' else 'x86_64' }}"

- name: Install winlogbeat to ship window event log
  win_chocolatey:
    name: winlogbeat
    state: present
    version: "{{ winlogbeat_version }}"
  when: logstash_endpoint_list is defined and logstash_endpoint_list

- name: Install google-chrome to make our life easier
  win_chocolatey:
    name: googlechrome
    state: present

- name: Deploy winlogbeat config
  win_template:
    src: "winlogbeat.yml"
    dest: '{{ chocolatey_lib_path }}\winlogbeat\tools\winlogbeat-{{ winlogbeat_version }}-windows-{{ machine_arch }}\winlogbeat.yml'
  notify: Enable winlogbeat service
  when: logstash_endpoint_list is defined and logstash_endpoint_list

# This seems to be window bug. I use this ansible module or my own PS script to
# set password it always return InvalidCredentialsError but the password is
# actually changed.

# So we need to do two things. Fireup the instance first, and then manually get
# the password via aws console. Then re-run the playbook which select the
# spawned instance - provide the initial_password.
# From now on we no longer need initial_password.

- name: Set admin password
  win_user:
    name: Administrator
    password: "{{ admin_password }}"
    state: present
    update_password: always
  ignore_errors: yes
  when: initial_password is defined and initial_password

- name: Change ansible admin password
  set_fact:
    ansible_password: "{{ admin_password }}"
  no_log: True
  when: initial_password is defined and initial_password
  vars:
    ansible_connection: local
